---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import ProjectCard from '@components/ProjectCard.astro';

export async function getStaticPaths() {
  const entries = await getCollection('team');
  return entries.map((e) => ({ params: { slug: e.slug }, props: { entry: e } }));
}

const { entry } = Astro.props;
const projects = await getCollection('projects');
const pubs = await getCollection('publications');

const linkedProjects = projects.filter((p) => entry.data.linkedProjects?.includes(p.slug));
const linkedPubs = pubs.filter((p) => entry.data.linkedPublications?.includes(p.slug));

const { Content } = await entry.render();
const name = [entry.data.prefix, entry.data.name].filter(Boolean).join(' ').trim();
const role = entry.data.role ?? entry.data.title ?? '';
const photo = entry.data.photo || '/uploads/avatar-placeholder.png';
---
<BaseLayout title={`${name} â€” SPARQ`}>
  <section class="py-12">
    <div class="container mx-auto px-4">
      <div class="grid gap-10 lg:grid-cols-[280px_1fr]">
        <!-- Left sidebar -->
        <aside class="lg:sticky lg:top-6 h-max">
          <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
            <div class="flex flex-col items-center text-center">
              <img
                src={photo}
                alt={name}
                class="h-36 w-36 rounded-full object-cover ring-1 ring-neutral-200"
                loading="lazy"
              />
              <h1 class="mt-4 text-xl font-semibold">{name}</h1>
              {role && <p class="mt-1 text-neutral-700">{role}</p>}

              <div class="mt-4 space-y-2 text-sm">
                {entry.data.email && (
                  <div>
                    <span class="text-neutral-500">Email:</span>{' '}
                    <a class="text-blue-700" href={`mailto:${entry.data.email}`}>{entry.data.email}</a>
                  </div>
                )}
                {entry.data.linkedin && (
                  <div>
                    <span class="text-neutral-500">LinkedIn:</span>{' '}
                    <a class="text-blue-700" href={entry.data.linkedin} target="_blank" rel="noopener">
                      View profile
                    </a>
                  </div>
                )}
                {entry.data.website && (
                  <div>
                    <span class="text-neutral-500">Website:</span>{' '}
                    <a class="text-blue-700" href={entry.data.website} target="_blank" rel="noopener">
                      {entry.data.website}
                    </a>
                  </div>
                )}
              </div>
            </div>
          </div>
        </aside>

        <!-- Right: bio + linked content -->
        <div>
          {entry.data.longSummary && <p class="text-lg text-neutral-800">{entry.data.longSummary}</p>}
          <article class="prose max-w-none mt-6">
            <Content />
          </article>

          {linkedProjects.length > 0 && (
            <div class="mt-8">
              <h3 class="text-lg font-semibold">Linked projects</h3>
              <div class="mt-4 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                {linkedProjects.map((p) => <ProjectCard project={p} />)}
              </div>
            </div>
          )}

          {linkedPubs.length > 0 && (
            <div class="mt-8">
              <h3 class="text-lg font-semibold">Linked publications</h3>
              <ul class="mt-4 list-disc pl-5">
                {linkedPubs.map((p) => (
                  <li>
                    <a class="text-blue-700" href={`/publications/${p.slug}`}>{p.data.title}</a>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
