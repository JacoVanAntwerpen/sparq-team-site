---
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import '@styles/tailwind.css';

const {
  title = 'SPARQ Team',
  description = 'Techno-economic analysis for net-zero',
} = Astro.props;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <title>{title}</title>

    <!-- Netlify Identity (needed to process invite links & show login modal) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      (function () {
        function getInviteToken() {
          // Accept "#invite_token=..." or "?invite_token=..." just in case
          const fromHash = new URLSearchParams(location.hash.slice(1)).get('invite_token');
          const fromQuery = new URLSearchParams(location.search).get('invite_token');
          return fromHash || fromQuery || null;
        }

        function goToAdminIfNotAlready() {
          if (!location.pathname.startsWith('/admin')) {
            location.href = '/admin/';
          }
        }

        document.addEventListener('DOMContentLoaded', function () {
          if (!window.netlifyIdentity) return;

          // Always init explicitly; some setups need this
          window.netlifyIdentity.init();

          const inviteToken = getInviteToken();

          // If landing from an invite link and not logged in, complete signup
          window.netlifyIdentity.on('init', (user) => {
            if (!user && inviteToken) {
              // Try native acceptInvite API first (best UX)
              window.netlifyIdentity
                .acceptInvite(inviteToken, true /* setPassword */)
                .then(() => {
                  // Success; go to admin
                  goToAdminIfNotAlready();
                })
                .catch(() => {
                  // Fallback: open signup modal
                  window.netlifyIdentity.open('signup');
                });
            }

            // If youâ€™re on /admin and not logged in, open the login modal
            if (!user && location.pathname.startsWith('/admin')) {
              window.netlifyIdentity.open('login');
            }
          });

          // After login, head to /admin
          window.netlifyIdentity.on('login', () => {
            goToAdminIfNotAlready();
          });
        });
      })();
    </script>
  </head>
  <body class="min-h-screen bg-gradient-to-b from-white to-neutral-50 text-neutral-900">
    <Header />
    <main><slot /></main>
    <Footer />
  </body>
</html>
