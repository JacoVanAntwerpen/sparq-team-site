<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SPARQ Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Netlify Identity widget (login/signup + invite handling) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- IMPORTANT: Manual init flag MUST come BEFORE loading decap-cms -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <!-- Decap CMS (pinned current 3.x) -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.7.0/dist/decap-cms.js"></script>
    <style>
      :root{--muted:#6b7280;--border:#e5e7eb}
      html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .auth-wrap{position:fixed;inset:0;display:grid;place-items:center;background:transparent;z-index:10}
      /* ðŸ”§ Hide the overlay when aria-hidden="true" */
      .auth-wrap[aria-hidden="true"]{display:none !important}
      .auth-card{border:1px solid var(--border);border-radius:14px;padding:20px 24px;background:#fff;box-shadow:0 10px 25px rgba(0,0,0,.06);width:360px;max-width:90vw}
      .brand{font-weight:700;font-size:20px;margin:0 0 6px}
      .muted{color:var(--muted);font-size:14px;margin:0 0 16px}
      .row{display:flex;gap:8px}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
      .btn.primary{background:#111827;color:#fff;border-color:#111827}
      .btn.hidden{display:none}
      .status{font-size:12px;color:var(--muted);margin-top:10px}
    </style>
  </head>
  <body>
    <div id="auth" class="auth-wrap" aria-hidden="false">
      <div class="auth-card">
        <p class="brand">SPARQ Admin</p>
        <p class="muted">Sign in to manage site content.</p>
        <div class="row" style="margin-bottom:8px;">
          <button id="loginBtn" class="btn primary">Log in</button>
          <button id="signupBtn" class="btn">Sign up</button>
          <button id="logoutBtn" class="btn hidden">Log out</button>
        </div>
        <div id="status" class="status">Idle</div>
      </div>
    </div>

    <script>
      // Small helpers
      const auth = document.getElementById('auth');
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const statusEl = document.getElementById('status');

      const setStatus = (t)=>{ if(statusEl) statusEl.textContent = t; };
      const showAuth = ()=> auth?.setAttribute('aria-hidden','false');
      const hideAuth = ()=> auth?.setAttribute('aria-hidden','true');

      function forceHideOverlay(){
        hideAuth();
        if (auth) auth.style.display = 'none'; // extra safety
      }

      function getTokenParam(){
        const url = new URL(window.location.href);
        const token = url.searchParams.get('token');
        const invite = url.searchParams.get('invite_token');
        if(invite) return { kind:'invite_token', value: invite };
        if(token)  return { kind:'token', value: token };
        return null;
      }
      function cleanURL(){
        if (window.history.replaceState) {
          const url = new URL(window.location.href);
          url.searchParams.delete('token');
          url.searchParams.delete('invite_token');
          window.history.replaceState({}, document.title, url.toString());
        }
      }

      // Wire buttons
      loginBtn.addEventListener('click', () => { forceHideOverlay(); window.netlifyIdentity.open('login'); });
      signupBtn.addEventListener('click', () => { forceHideOverlay(); window.netlifyIdentity.open('signup'); });
      logoutBtn.addEventListener('click', () => { window.netlifyIdentity?.logout(); });

      // Initialize Identity and CMS
      document.addEventListener('DOMContentLoaded', () => {
        if (!window.netlifyIdentity) {
          setStatus('Netlify Identity not available.');
          return;
        }

        // Identity bootstrap
        window.netlifyIdentity.on('init', user => {
          if (user) {
            setStatus(`Logged in as ${user.email||'user'}`);
            forceHideOverlay(); // ensure overlay is hidden if already logged in
            initCMSWhenReady();
          } else {
            showAuth();
          }
        });

        // Process invite/confirmation tokens
        const tok = getTokenParam();
        if (tok) {
          setStatus('Processing invite/confirmationâ€¦');
          forceHideOverlay();
          const p = tok.kind === 'invite_token'
            ? window.netlifyIdentity.acceptInvite(tok.value, true)
            : window.netlifyIdentity.confirm(tok.value, true);
          Promise.resolve(p)
            .then(() => { setStatus('Verified. Loading adminâ€¦'); forceHideOverlay(); cleanURL(); })
            .catch(() => { setStatus('Token detected. Complete in the dialog.'); forceHideOverlay(); window.netlifyIdentity.open(tok.kind === 'invite_token' ? 'signup' : 'login'); });
        }

        window.netlifyIdentity.on('login', (user) => {
          setStatus(`Logged in as ${user.email||'user'}`);
          forceHideOverlay(); // ðŸ”§ actually hide/remove overlay after login
          cleanURL();
          initCMSWhenReady();
        });

        window.netlifyIdentity.on('logout', () => {
          setStatus('Logged out');
          if (auth) auth.style.display = ''; // allow overlay to show again
          showAuth();
        });

        // Keep logout button state in sync
        setInterval(() => {
          const u = window.netlifyIdentity.currentUser();
          logoutBtn.classList.toggle('hidden', !u);
        }, 1000);

        // Initialize CMS (manual)
        function initCMSWhenReady(attempt = 0) {
          if (typeof CMS === 'undefined') {
            if (attempt < 50) return setTimeout(() => initCMSWhenReady(attempt+1), 100);
            return setStatus('CMS failed to load.');
          }
          try {
            setStatus('Initializing CMSâ€¦');
            CMS.init({ config: { load_config_file: true } });
            setStatus('CMS initialized');
          } catch (e) {
            console.error('CMS init error:', e);
            setStatus('CMS failed to initialize (see console).');
          }
        }
      });
    </script>
  </body>
</html>
